!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e="undefined"!=typeof globalThis?globalThis:e||self).ShopifySurfacePickUp=t()}(this,function(){"use strict";const a="pxu-shopify-surface-pick-up",o="surface-pick-up--loading";async function r(e=!1){var t=JSON.parse(localStorage.getItem(a));return t&&t.timestamp+36e5>=Date.now()?t:e?async function(){return new Promise((t,e)=>{navigator.geolocation?navigator.geolocation.getCurrentPosition(({coords:e})=>t(e),e,{maximumAge:36e5,timeout:5e3}):e()})}().then(e=>(async function({latitude:e,longitude:t}){var i={latitude:e,longitude:t,timestamp:Date.now()};return localStorage.setItem(a,JSON.stringify(i)),fetch("/localization.json",{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({latitude:e,longitude:t})}).then(()=>({latitude:e,longitude:t}))}(e),e)):null}return class{constructor(e,t){this.el=e;e=window.PXUTheme||window.Theme;this.options={root_url:e&&e.routes&&e.routes.root_url||"",...t},this.options.root_url=this.options.root_url.replace(/(.*)\/$/,"$1"),this.callbacks=[],this.onBtnPress=null,this.latestVariantId=null}load(e){return e?(this.latestVariantId=e,this.el.classList.add(o),this._getData(e).then(e=>this._injectData(e))):(this.el.innerHTML="",Promise.resolve(!0))}onModalRequest(e){0<=this.callbacks.indexOf(e)||this.callbacks.push(e)}offModalRequest(e){this.callbacks.splice(this.callbacks.indexOf(e))}unload(){this.callbacks=[],this.el.innerHTML=""}_getData(o){return new Promise(n=>{const s=new XMLHttpRequest;var e=`${this.options.root_url}/variants/${o}/?section_id=surface-pick-up`;s.open("GET",e,!0),s.onload=()=>{const e=s.response;var t=e.querySelector('[data-html="surface-pick-up-embed"]');const i=e.querySelector('[data-html="surface-pick-up-items"]');var a=i.content.querySelectorAll("[data-surface-pick-up-item]");n({embed:t,itemsContainer:i,items:a,variantId:o})},s.onerror=()=>{n({embed:{innerHTML:""},itemsContainer:{innerHTML:""},items:[],variantId:o})},s.responseType="document",s.send()})}_injectData({embed:e,itemsContainer:t,items:i,variantId:a}){if(a!==this.latestVariantId||0===i.length)return this.el.innerHTML="",void this.el.classList.remove(o);this.el.innerHTML=e.innerHTML,this.el.classList.remove(o);let n=!1;const s=()=>n?Promise.resolve():r(!0).then(c=>{i.forEach(e=>{const t=e.querySelector("[data-distance]"),i=e.querySelector("[data-distance-unit]");var a,n,s=i.dataset.distanceUnit,o=parseFloat(t.dataset.latitude),r=parseFloat(t.dataset.longitude);if(c&&isFinite(o)&&isFinite(r)){const l=(a=c.latitude,n=c.longitude,e=o,o=r,r=s,s=Math.PI/180,r="metric"===r?6378.14:3959,a*=s,e*=s,s=n*s-o*s,s=Math.sin((a-e)/2)**2+Math.cos(a)*Math.cos(e)*Math.sin(s/2)**2,r*(2*Math.atan2(Math.sqrt(s),Math.sqrt(1-s))));t.innerHTML=l.toFixed(1)}else t.remove(),i.remove()})}).catch(e=>{console.log(e),i.forEach(e=>{const t=e.querySelector("[data-distance]"),i=e.querySelector("[data-distance-unit]");t.remove(),i.remove()})}).finally(()=>{n=!0});this.el.querySelector("[data-surface-pick-up-embed-modal-btn]").addEventListener("click",()=>{s().then(()=>this.callbacks.forEach(e=>e(t.innerHTML)))})}}});