!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e="undefined"!=typeof globalThis?globalThis:e||self).ShopifySectionsManager=t()}(this,function(){"use strict";function n(e){return(n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}function s(e,t,n){return t&&i(e.prototype,t),n&&i(e,n),e}function t(t,e){var n,o=Object.keys(t);return Object.getOwnPropertySymbols&&(n=Object.getOwnPropertySymbols(t),e&&(n=n.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),o.push.apply(o,n)),o}function c(i){for(var e=1;e<arguments.length;e++){var s=null!=arguments[e]?arguments[e]:{};e%2?t(Object(s),!0).forEach(function(e){var t,n,o;t=i,o=s[n=e],n in t?Object.defineProperty(t,n,{value:o,enumerable:!0,configurable:!0,writable:!0}):t[n]=o}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(s)):t(Object(s)).forEach(function(e){Object.defineProperty(i,e,Object.getOwnPropertyDescriptor(s,e))})}return i}var r=function(){function t(e){o(this,t);this.callbacks=new WeakMap,this._observerCallback=this._observerCallback.bind(this),this.observer=new IntersectionObserver(this._observerCallback,c(c({},{rootMargin:"30%",threshold:0}),e))}return s(t,[{key:"add",value:function(e,t){this.callbacks.set(e,t),this.observer.observe(e)}},{key:"remove",value:function(e){this.observer.unobserve(e),this.callbacks.delete(e)}},{key:"unload",value:function(){this.observer.disconnect()}},{key:"_observerCallback",value:function(e,i){var s=this;e.forEach(function(e){var t,n=e.isIntersecting,o=e.target;!0===n&&(i.unobserve(o),"function"==typeof(t=s.callbacks.get(o))&&t(),s.callbacks.delete(o))})}}]),t}();function a(e,t){if(e&&e[t]){for(var n=arguments.length,o=new Array(2<n?n-2:0),i=2;i<n;i++)o[i-2]=arguments[i];e[t].apply(e,o)}}return function(){function e(){o(this,e),this.handlers={},this.instances={},this.options={},this.lazyLoader=null,this._onSectionEvent=this._onSectionEvent.bind(this),document.addEventListener("shopify:section:load",this._onSectionEvent),document.addEventListener("shopify:section:unload",this._onSectionEvent),document.addEventListener("shopify:section:select",this._onSectionEvent),document.addEventListener("shopify:section:deselect",this._onSectionEvent),document.addEventListener("shopify:section:reorder",this._onSectionEvent),document.addEventListener("shopify:block:select",this._onSectionEvent),document.addEventListener("shopify:block:deselect",this._onSectionEvent)}return s(e,[{key:"unbind",value:function(){document.removeEventListener("shopify:section:load",this._onSectionEvent),document.removeEventListener("shopify:section:unload",this._onSectionEvent),document.removeEventListener("shopify:section:select",this._onSectionEvent),document.removeEventListener("shopify:section:deselect",this._onSectionEvent),document.removeEventListener("shopify:section:reorder",this._onSectionEvent),document.removeEventListener("shopify:block:select",this._onSectionEvent),document.removeEventListener("shopify:block:deselect",this._onSectionEvent);for(var e=0;e<this.instances.length;e++)a(this.instances[e],"onSectionUnload");this.handlers={},this.options={},this.lazyLoader.unload(),this.lazyLoader=null,this.instances={}}},{key:"register",value:function(e,t,n){var o=2<arguments.length&&void 0!==n?n:{};this.handlers[e]&&console.warn("Sections: section handler already exists of type '".concat(e,"'.")),this.handlers[e]=t,this.options[e]=o,this._initSections(e)}},{key:"_initSections",value:function(i){var s=this,c=document.querySelectorAll('[data-section-type="'.concat(i,'"]'));if(c)for(var e=0;e<c.length;e++){var t=function(e){var t=c[e].parentNode,n=t.querySelector("[data-section-id]");if(!n)return console.warn("Sections: unable to find section id for '".concat(i,"'."),t),{v:void 0};var o=n.getAttribute("data-section-id");if(!o)return console.warn("Sections: unable to find section id for '".concat(i,"'."),t),{v:void 0};s.options[i]&&s.options[i].lazy?(null===s.lazyLoader&&(s.lazyLoader=new r),s.lazyLoader.add(t,function(){return s._createInstance(o,t)})):s._createInstance(o,t)}(e);if("object"===n(t))return t.v}}},{key:"_onSectionEvent",value:function(e){var t=e.target,n=e.detail,o=n.sectionId,i=n.blockId,s=this.instances[o];switch(e.type){case"shopify:section:load":this._createInstance(o,t);break;case"shopify:section:unload":a(s,"onSectionUnload",{el:t,id:o}),this.lazyLoader&&this.lazyLoader.remove(t),delete this.instances[o];break;case"shopify:section:select":a(s,"onSectionSelect",{el:t,id:o});break;case"shopify:section:deselect":a(s,"onSectionDeselect",{el:t,id:o});break;case"shopify:section:reorder":a(s,"onSectionReorder",{el:t,id:o});break;case"shopify:block:select":a(s,"onSectionBlockSelect",{el:t,id:i});break;case"shopify:block:deselect":a(s,"onSectionBlockDeselect",{el:t,id:i})}}},{key:"_postMessage",value:function(t,n){var o=this;Object.keys(this.instances).forEach(function(e){a(o.instances[e],"onSectionMessage",t,n)})}},{key:"_createInstance",value:function(e,t){var n,o,i,s,c=t.querySelector("[data-section-type]");!c||(n=c.getAttribute("data-section-type"))&&((o=this.handlers[n])?(i=function(e){var t=e.querySelector("[data-section-data]");if(!t)return{};var n=t.getAttribute("data-section-data")||t.innerHTML;try{return JSON.parse(n)}catch(e){return console.warn("Sections: invalid section data found. ".concat(e.message)),{}}}(t),s=this._postMessage.bind(this),this.instances[e]=o({id:e,type:n,el:t,data:i,postMessage:s})):console.warn("Sections: unable to find section handler for type '".concat(n,"'.")))}}]),e}()});